name: è‡ªåŠ¨ç­¾åˆ°ç»­è´¹éº¦å—è”æœº

on:
  schedule:
    - cron: '0 4 * * *' # æ¯å¤© 4 ç‚¹è¿è¡Œ
  workflow_dispatch:

jobs:
  read-and-access:
    runs-on: ubuntu-22.04 # æ›´æ–°ä¸ºæ”¯æŒçš„è¿è¡Œç¯å¢ƒ

    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4 # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5 # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
      with:
        python-version: '3.10'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          libnss3 \
          libxss1 \
          libasound2 \
          libx11-xcb1 \
          libxcomposite1 \
          libxcursor1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libgtk-3-0 \
          jq # æ˜¾å¼å®‰è£… jq ç”¨äº JSON è§£æ
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -f -y
        rm -rf google-chrome-stable_current_amd64.deb

    - name: å®‰è£… Python ä¾èµ–
      run: |
        cd minekuai
        python -m ensurepip --upgrade
        pip install -U pip
        pip install -r requirements.txt

    - name: ç­¾åˆ°ç»­è´¹éº¦å—è”æœº
      env:
        MK_TOKENS: ${{ secrets.MK_TOKENS }}
      run: |
        #!/bin/bash
        set -e
        if [ -z "$MK_TOKENS" ]; then
          echo "âŒ MK_TOKENS ç§˜å¯†å˜é‡æœªè®¾ç½®ï¼"
          exit 1
        fi
        IFS=',' read -r -a entries <<< "$MK_TOKENS"
        for entry in "${entries[@]}"; do
          IFS=':' read -r user password server <<< "$entry"
          cd minekuai
          echo "ğŸ” æ­£åœ¨å°è¯•ç™»å½•..."
          python main.py --username "$user" --password "$password"
          if [ ! -s local.s ]; then
            echo "âŒ ç™»å½•å¤±è´¥ï¼Œlocal.s æ–‡ä»¶ä¸ºç©ºï¼è¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ã€‚"
            continue
          fi
          access_token=$(cat local.s)
          user_agent=$(cat u.a)
          echo "âœ… ç™»å½•æˆåŠŸï¼Œå¼€å§‹ç­¾åˆ°..."
          sign_response=$(curl -s --retry 3 'https://api.minekuai.com/system/sign' \
            -H "authorization: Bearer $access_token" \
            -H "clientid: 3991ee92fe77fa9672e5eca721151dab" \
            -H "content-language: zh_CN" \
            -H "origin: https://minekuai.com" \
            -H "user-agent: Mozilla/5.0")
          msg_sign=$(echo "$sign_response" | jq -r '.msg // "æœªçŸ¥é”™è¯¯"')
          echo "ğŸ“Œ ç­¾åˆ°ç»“æœï¼š$msg_sign"
          echo "ğŸ”„ æ­£åœ¨å°è¯•ç»­è´¹æœåŠ¡å™¨..."
          renew_response=$(curl -s --retry 3 -X POST "https://api.minekuai.com/system/mineKuaiSystem/reNewInstance?serverId=$server&days=1" \
            -H "authorization: Bearer $access_token" \
            -H "clientid: 3991ee92fe77fa9672e5eca721151dab" \
            -H "content-language: zh_CN" \
            -H "origin: https://minekuai.com" \
            -H "user-agent: Mozilla/5.0")
          msg_renew=$(echo "$renew_response" | jq -r '.msg // "æœªçŸ¥é”™è¯¯"')
          echo "ğŸ”„ ç»­è´¹ç»“æœï¼š$msg_renew"
          rm -rf u.a local.s
          echo "âœ… å¤„ç†å®Œæˆï¼"
          echo "---------------------------------------"
        done
